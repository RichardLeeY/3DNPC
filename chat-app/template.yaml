AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  chat-app

  Sample SAM Template for chat-app

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 30
    MemorySize: 256

Resources:
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "my-website-bucket-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedOrigins:
              - "*"
            ExposedHeaders:
              - ETag
            MaxAge: 3000

  # CloudFront Origin Access Identity
  WebsiteOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: OAC for my website bucket
        Name: my-website-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution
  WebsiteDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        DefaultCacheBehavior:
          ViewerProtocolPolicy: redirect-to-https
          TargetOriginId: WebsiteOrigin
          ForwardedValues:
            QueryString: false
            Headers:
              - Origin
              - Access-Control-Request-Headers
              - Access-Control-Request-Method
          AllowedMethods:
            - GET
            - HEAD
          DefaultTTL: 0
          MinTTL: 0
          MaxTTL: 0
        DefaultRootObject: index.html
        Enabled: true
        HttpVersion: http2
        IPV6Enabled: true
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        Origins:
          - Id: WebsiteOrigin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            OriginAccessControlId: !Ref WebsiteOAC
            S3OriginConfig:
              OriginAccessIdentity: ""

  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              "Service": "cloudfront.amazonaws.com"
            Action: s3:GetObject
            Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${WebsiteDistribution}"
  GameMetadataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: GameMetadata
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: gameid
          AttributeType: S
      KeySchema:
        - AttributeName: gameid
          KeyType: HASH
  FFmpegLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: ffmpeg-layer
      Description: FFmpeg layer for Lambda
      ContentUri: ./assets/ffmpeg.zip
      CompatibleRuntimes:
        - python3.9

  Wav2Mp3Function:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: wav2mp3Func/
      Handler: app.lambda_handler
      Runtime: python3.9
      Layers:
        - !Ref LayerBoto3
        - !Ref FFmpegLayer
      Timeout: 300
      Architectures:
        - x86_64
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Sid: VisualEditor2
              Effect: Allow
              Action:
                - "s3:PutObject"
                - "s3:GetObject"
              Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/*"
  TtsAsyncFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: ttsAsync/
      Handler: app.lambda_handler
      Runtime: python3.9
      Layers:
        - !Ref LayerBoto3
        - !Ref LayerScipy
      Timeout: 300
      Architectures:
        - x86_64
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Sid: InvokeSagemakerModel
              Effect: Allow
              Action:
                - "sagemaker:InvokeEndpoint"
              Resource: "*"
            - Sid: VisualEditor2
              Effect: Allow
              Action:
                - "s3:PutObject"
                - "s3:GetObject"
              Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/*"
  ApiGatewayRestApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: chat
      StageName: prod
      Auth:
        ApiKeyRequired: true # sets for all methods
  ApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Enabled: true
      StageKeys:
        - RestApiId: !Ref ApiGatewayRestApi
          StageName: !Ref ApiGatewayRestApi.Stage

  UsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      ApiStages:
        - ApiId: !Ref ApiGatewayRestApi
          Stage: !Ref ApiGatewayRestApi.Stage
      Quota:
        Limit: 1000
        Period: DAY
      Throttle:
        BurstLimit: 100
        RateLimit: 50
      UsagePlanName: ChatUsagePlan

  UsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref ApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref UsagePlan

  ChatFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: chat/
      Handler: app.lambda_handler
      Runtime: python3.9
      Layers:
        - !Ref LayerBoto3
        - !Ref LayerScipy
      Timeout: 30
      Architectures:
        - x86_64
      Environment:
        Variables:
          ttsFunction: !GetAtt TtsAsyncFunction.Arn
          BUCKET_NAME: !Ref WebsiteBucket
          DOMAIN_NAME: !GetAtt WebsiteDistribution.DomainName
      Events:
        InferenceEvent:
          Type: Api
          Properties:
            Path: /inference
            Method: POST
            RestApiId: !Ref ApiGatewayRestApi
        WisperEvent:
          Type: Api
          Properties:
            Path: /wisper
            Method: POST
            RestApiId: !Ref ApiGatewayRestApi
        GetGameEvent:
          Type: Api
          Properties:
            Path: /games/{gameid}
            Method: GET
            RestApiId: !Ref ApiGatewayRestApi
        UpdateGameEvent:
          Type: Api
          Properties:
            Path: /games/{gameid}
            Method: PUT
            RestApiId: !Ref ApiGatewayRestApi

      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Sid: InvokeModel
              Effect: Allow
              Action:
                - "bedrock:InvokeModelWithResponseStream"
                - "bedrock:InvokeModel"
              Resource: "arn:aws:bedrock:*::foundation-model/*"
            - Sid: InvokeSagemakerModel
              Effect: Allow
              Action:
                - "sagemaker:InvokeEndpoint"
              Resource: "*"
            - Sid: ListFM
              Effect: Allow
              Action:
                - "bedrock:ListFoundationModels"
              Resource: "*"
            - Sid: GetTable
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Scan
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt GameMetadataTable.Arn
        - Version: "2012-10-17"
          Statement:
            - Sid: VisualEditor0
              Effect: Allow
              Action: "lambda:InvokeFunction"
              Resource: "arn:aws:lambda:us-east-1:*:function:*"
            - Sid: VisualEditor1
              Effect: Allow
              Action: "polly:SynthesizeSpeech"
              Resource: "*"
            - Sid: VisualEditor2
              Effect: Allow
              Action:
                - "s3:PutObject"
                - "s3:GetObject"
                - "s3:GetBucketCors"
              Resource:
                - !Sub "arn:aws:s3:::${WebsiteBucket}/*"
                - !Sub "arn:aws:s3:::${WebsiteBucket}"

 
  LayerBoto3:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ./layers/boto3-layer/
      CompatibleRuntimes:
        - python3.9
    Metadata:
      BuildMethod: python3.9

  LayerScipy:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ./layers/scipy-layer/
      CompatibleRuntimes:
        - python3.9
    Metadata:
      BuildMethod: python3.9

  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: "true"
Outputs:
  ChatFunction:
    Description: Chat app Lambda Function ARN
    Value: !GetAtt ChatFunction.Arn
  ChatFunctionIamRole:
    Description: Implicit IAM Role created for Chat app function
    Value: !GetAtt ChatFunctionRole.Arn
  ApiKey:
    Description: API Key for Usage Plan
    Value: !Ref ApiKey
  WebsiteCloudFrontDomain:
    Description: Cloudfront domain for the website
    Value: !GetAtt WebsiteDistribution.DomainName
